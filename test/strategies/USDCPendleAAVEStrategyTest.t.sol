// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.29;

import {Test, console} from "forge-std/Test.sol";
import {SparkleXVault} from "../../src/SparkleXVault.sol";
import {PendleAAVEStrategy} from "../../src/strategies/aave/PendleAAVEStrategy.sol";
import {AAVEHelper} from "../../src/strategies/aave/AAVEHelper.sol";
import {TokenSwapper} from "../../src/utils/TokenSwapper.sol";
import {ERC20} from "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";
import {Vm} from "forge-std/Vm.sol";
import {IWithdrawRequestNFT} from "../../interfaces/etherfi/IWithdrawRequestNFT.sol";
import {IPool} from "../../interfaces/aave/IPool.sol";
import {IAaveOracle} from "../../interfaces/aave/IAaveOracle.sol";
import {IPriceOracleGetter} from "../../interfaces/aave/IPriceOracleGetter.sol";
import {TestUtils} from "../TestUtils.sol";
import {Constants} from "../../src/utils/Constants.sol";
import {IPAllActionV3} from "@pendle/contracts/interfaces/IPAllActionV3.sol";
import {IPPrincipalToken} from "@pendle/contracts/interfaces/IPPrincipalToken.sol";
import {IPMarketV3} from "@pendle/contracts/interfaces/IPMarketV3.sol";
import {PendleHelper} from "../../src/strategies/pendle/PendleHelper.sol";
import {DummyDEXRouter} from "../mock/DummyDEXRouter.sol";
import {BasePendleStrategyTest} from "./BasePendleStrategyTest.t.sol";

// run this test with mainnet fork
// forge test --fork-url <rpc_url> --match-path USDCPendleAAVEStrategyTest -vvv
contract USDCPendleAAVEStrategyTest is BasePendleStrategyTest {
    AAVEHelper public aaveHelper;
    address public aaveHelperOwner;
    uint256 public magicUSDCAmountLeveraged = 9000000000; //9000e6
    uint256 public magicUSDCAmountCollect = 365000000; //365e6
    uint256 public magicPTAmountRedeemed = 200000000000000000000; //200e18
    uint256 public magicPTAmountCollected = 3600000000000000000000; //3600e18
    uint256 public magicPTAmountCollectAll = 6400000000000000000000; //6400e18

    ///////////////////////////////
    // Note this address is only meaningful for this test
    ///////////////////////////////
    address public constant PENDLE_AAVE_STRATEGY_ADDRESS = 0xf10b150ae0c2D2C0dF82AE181dBcF2eA71573401;
    string public constant PENDLE_AAVE_STRATEGY_NAME = "sparklex.pendle.aave.strategy";

    ///////////////////////////////
    // mainnet pendle PT pools: active
    ///////////////////////////////
    IPool aavePool = IPool(0x87870Bca3F3fD6335C3F4ce8392D69350B4fA4E2);
    address public constant sUSDe = 0x9D39A5DE30e57443BfF2A8307A4256c8797A3497;
    address public constant sUSDe_FEED = 0xFF3BC18cCBd5999CE63E788A1c250a88626aD099;

    // USDe JUL31 market
    IPPrincipalToken PT_ADDR3 = IPPrincipalToken(0x917459337CaAC939D41d7493B3999f571D20D667);
    address YT_ADDR3 = 0x733Ee9Ba88f16023146EbC965b7A1Da18a322464;
    IPMarketV3 MARKET_ADDR3 = IPMarketV3(0x9Df192D13D61609D1852461c4850595e1F56E714);
    address constant PT3_Whale = 0xBBBBBbbBBb9cC5e90e3b3Af64bdAF62C37EEFFCb;
    address constant YIELD_TOKEN_FEED3 = 0xa569d910839Ae8865Da8F8e70FfFb0cBA869F961;
    uint256 public constant USDC_TO_PT3_DUMMY_PRICE = 1010000000000000000; //1.01
    address public constant UNDERLYING_YIELD_ADDR3 = 0x4c9EDD5852cd905f086C759E8383e09bff1E68B3;

    // sUSDe JUL31 market
    address public constant PT_ATOKEN_ADDR1 = 0xDE6eF6CB4aBd3A473ffC2942eEf5D84536F8E864;
    // USDe JUL31 market
    address public constant PT_ATOKEN_ADDR3 = 0x312ffC57778CEfa11989733e6E08143E7E229c1c;

    function setUp() public {
        stkVault = new SparkleXVault(ERC20(usdc), "SparkleXVault", "SPXV");
        stkVOwner = stkVault.owner();
        _changeWithdrawFee(stkVOwner, address(stkVault), 0);

        vm.startPrank(stkVOwner);
        stkVault.setEarnRatio(Constants.TOTAL_BPS);
        vm.stopPrank();

        swapper = new TokenSwapper();
        mockRouter = new DummyDEXRouter();
    }

    function test_GetMaxLTV() public {
        (myStrategy, strategist) = _createPendleStrategy(true);
        uint256 _ltv = aaveHelper.getMaxLTV();
        assertTrue(_ltv >= 9000 && _ltv <= 9060);
    }

    function test_Basic_Flow_PendleAAVE(uint256 _testVal) public {
        (myStrategy, strategist) = _createPendleStrategy(false);
        _fundFirstDepositGenerouslyWithERC20(mockRouter, address(stkVault), usdcPerETH);
        address _user = TestUtils._getSugarUser();

        TestUtils._makeVaultDepositWithMockRouter(
            mockRouter, address(stkVault), _user, usdcPerETH, _testVal, 10 ether, 100 ether
        );

        uint256 _initSupply = magicUSDCAmount;
        uint256 _initDebt = magicUSDCAmountLeveraged; //aaveHelper.previewLeverageForInvest(_initSupply, _initDebt);

        bytes memory _prepareCALLDATA = _getZapInCalldataFromSDK(address(PT_ADDR1), magicUSDCAmount);
        bytes memory _flCALLDATA = _getZapInCalldataFromSDK(address(PT_ADDR1), _initDebt);

        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).invest(
            _initSupply, _initDebt, abi.encode(_prepareCALLDATA, _initDebt, _flCALLDATA)
        );
        vm.stopPrank();

        _printAAVEPosition();
        (uint256 _netSupply, uint256 _debt, uint256 _totalSupply) =
            PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(true);
        assertTrue(_assertApproximateEq(_totalSupply, (_initSupply + _initDebt), 20 * MIN_SHARE));
        _checkBasicInvariants(address(stkVault));

        (, uint256 _debtInSupply, uint256 _totalInSupply) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(false);

        uint256 _toRedeem = magicPTAmountRedeemed; //aaveHelper.getMaxRedeemableAmount();
        assertTrue(_toRedeem < type(uint256).max);
        bytes memory _redeemCALLDATA = _getStormOutCalldataFromSDK(address(PT_ADDR1), _toRedeem);

        vm.expectRevert(Constants.TOO_MUCH_SUPPLY_TO_REDEEM.selector);
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).redeem(type(uint256).max, _redeemCALLDATA);
        vm.stopPrank();

        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).redeem(_toRedeem, _redeemCALLDATA);
        vm.stopPrank();

        (, uint256 _debtInSupply2, uint256 _totalInSupply2) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(false);
        assertTrue(_assertApproximateEq(_totalInSupply, (_totalInSupply2 + _toRedeem), 10 * BIGGER_TOLERANCE));
        console.log("_debtInSupply:%d,_debtInSupply2:%d", _debtInSupply, _debtInSupply2);
        assertTrue(_assertApproximateEq(_debtInSupply, (_debtInSupply2 + _toRedeem), 10 * BIGGER_TOLERANCE));

        _printAAVEPosition();
        _checkBasicInvariants(address(stkVault));

        uint256[] memory _previewPortionCollect = aaveHelper.previewCollect(magicUSDCAmountCollect);
        assertEq(5, _previewPortionCollect.length);
        console.log(
            "_previewPortionCollect[0]:%d,_previewPortionCollect[4]:%d",
            _previewPortionCollect[0],
            _previewPortionCollect[4]
        );

        bytes memory _collectCALLDATA = _getStormOutCalldataFromSDK(address(PT_ADDR1), magicPTAmountCollected);
        uint256 _vaultBalance = ERC20(usdc).balanceOf(address(stkVault));
        vm.startPrank(swapper.owner());
        swapper.setSlippage(9500);
        vm.stopPrank();
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).collect(magicUSDCAmountCollect, _collectCALLDATA);
        vm.stopPrank();
        uint256 _vaultBalanceAfter = ERC20(usdc).balanceOf(address(stkVault));
        console.log("_vaultBalance:%d,_vaultBalanceAfter:%d", _vaultBalance, _vaultBalanceAfter);
        assertTrue(_assertApproximateEq(magicUSDCAmountCollect, (_vaultBalanceAfter - _vaultBalance), 100 * MIN_SHARE));
        _checkBasicInvariants(address(stkVault));

        (,, _totalInSupply) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(false);
        console.log("_totalInSupply:%d", _totalInSupply);
        bytes memory _collectAllCALLDATA = _getStormOutCalldataFromSDK(address(PT_ADDR1), magicPTAmountCollectAll);
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).collectAll(_collectAllCALLDATA);
        vm.stopPrank();
        _checkBasicInvariants(address(stkVault));

        (uint256 _netSupplyInAsset,,) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(true);
        uint256 _ptValueInAsset =
            pendleHelper._getAmountInAsset(usdc, address(PT_ADDR1), ERC20(address(PT_ADDR1)).balanceOf(myStrategy));
        assertEq(
            _netSupplyInAsset + _ptValueInAsset + ERC20(usdc).balanceOf(myStrategy),
            PendleAAVEStrategy(myStrategy).totalAssets()
        );
    }

    function test_Change_PT_Supply(uint256 _testVal) public {
        (myStrategy, strategist) = _createPendleStrategy(true);
        _fundFirstDepositGenerouslyWithERC20(mockRouter, address(stkVault), usdcPerETH);
        address _user = TestUtils._getSugarUser();

        TestUtils._makeVaultDepositWithMockRouter(
            mockRouter, address(stkVault), _user, usdcPerETH, _testVal, 10 ether, 100 ether
        );

        uint256 _initSupply = magicUSDCAmount;
        uint256 _initDebt = magicUSDCAmountLeveraged; //aaveHelper.previewLeverageForInvest(_initSupply, _initDebt);

        bytes memory _prepareCALLDATA =
            _generateSwapCalldataForBuy(myStrategy, address(MARKET_ADDR1), 0, magicUSDCAmount);
        bytes memory _flCALLDATA = _generateSwapCalldataForBuy(myStrategy, address(MARKET_ADDR1), 0, _initDebt);
        _prepareSwapForMockRouter(mockRouter, usdc, address(PT_ADDR1), PT1_Whale, USDC_TO_PT1_DUMMY_PRICE);
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).invest(
            _initSupply, _initDebt, abi.encode(_prepareCALLDATA, _initDebt, _flCALLDATA)
        );
        vm.stopPrank();
        _checkBasicInvariants(address(stkVault));

        vm.expectRevert(Constants.POSITION_STILL_IN_USE.selector);
        vm.startPrank(aaveHelperOwner);
        aaveHelper.setTokens(ERC20(address(PT_ADDR3)), ERC20(usdc), ERC20(PT_ATOKEN_ADDR3), 0);
        vm.stopPrank();

        (,, uint256 _totalInSupply) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(false);
        bytes memory _collectAllCALLDATA =
            _generateSwapCalldataForSell(myStrategy, address(MARKET_ADDR1), 0, _totalInSupply);
        _prepareSwapForMockRouter(
            mockRouter,
            address(PT_ADDR1),
            usdc,
            usdcWhale,
            (Constants.ONE_ETHER * Constants.ONE_ETHER / USDC_TO_PT1_DUMMY_PRICE)
        );
        uint256 _vaultBalance = ERC20(usdc).balanceOf(address(stkVault));
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).collectAll(_collectAllCALLDATA);
        vm.stopPrank();
        uint256 _vaultBalanceAfter = ERC20(usdc).balanceOf(address(stkVault));
        console.log("_vaultBalance:%d,_vaultBalanceAfter:%d", _vaultBalance, _vaultBalanceAfter);
        assertTrue(_assertApproximateEq(magicUSDCAmount, (_vaultBalanceAfter - _vaultBalance), 10 * MIN_SHARE));
        _checkBasicInvariants(address(stkVault));
        (,, _totalInSupply) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(false);
        assertEq(0, _totalInSupply);
        assertEq(0, ERC20(address(PT_ADDR1)).balanceOf(myStrategy));

        // change to new PT
        _changeSettingToNewPT();

        _prepareCALLDATA = _generateSwapCalldataForBuy(myStrategy, address(MARKET_ADDR3), 0, magicUSDCAmount);
        _flCALLDATA = _generateSwapCalldataForBuy(myStrategy, address(MARKET_ADDR3), 0, _initDebt);
        _prepareSwapForMockRouter(mockRouter, usdc, address(PT_ADDR3), PT3_Whale, USDC_TO_PT3_DUMMY_PRICE);
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).invest(
            _initSupply, _initDebt, abi.encode(_prepareCALLDATA, _initDebt, _flCALLDATA)
        );
        vm.stopPrank();
        _checkBasicInvariants(address(stkVault));
        (,, uint256 _totalInAsset) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(true);
        _assertApproximateEq(_totalInAsset, (_initSupply + _initDebt), 1 * MIN_SHARE);
    }

    function test_FullDeloop_Pendle(uint256 _testVal) public {
        (myStrategy, strategist) = _createPendleStrategy(true);
        _fundFirstDepositGenerouslyWithERC20(mockRouter, address(stkVault), usdcPerETH);
        address _user = TestUtils._getSugarUser();

        TestUtils._makeVaultDepositWithMockRouter(
            mockRouter, address(stkVault), _user, usdcPerETH, _testVal, 10 ether, 100 ether
        );

        uint256 _initDebt = magicUSDCAmountLeveraged; //aaveHelper.previewLeverageForInvest(magicUSDCAmount, _initDebt);
        bytes memory _prepareCALLDATA =
            _generateSwapCalldataForBuy(myStrategy, address(MARKET_ADDR1), 0, magicUSDCAmount);
        bytes memory _flCALLDATA = _generateSwapCalldataForBuy(myStrategy, address(MARKET_ADDR1), 0, _initDebt);
        _prepareSwapForMockRouter(mockRouter, usdc, address(PT_ADDR1), PT1_Whale, USDC_TO_PT1_DUMMY_PRICE);
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).invest(
            magicUSDCAmount, _initDebt, abi.encode(_prepareCALLDATA, _initDebt, _flCALLDATA)
        );
        vm.stopPrank();

        _prepareSwapForMockRouter(
            mockRouter,
            address(PT_ADDR1),
            usdc,
            usdcWhale,
            (Constants.ONE_ETHER * Constants.ONE_ETHER / USDC_TO_PT1_DUMMY_PRICE)
        );
        (, uint256 _debtInAsset,) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(true);

        for (uint256 i = 0; i < 30; i++) {
            uint256 _toRedeem = aaveHelper.getMaxRedeemableAmount();

            bytes memory _redeemCALLDATA = _generateSwapCalldataForSell(myStrategy, address(MARKET_ADDR1), 0, _toRedeem);
            vm.startPrank(strategist);
            PendleAAVEStrategy(myStrategy).redeem(_toRedeem, _redeemCALLDATA);
            vm.stopPrank();

            (, _debtInAsset,) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(true);
            console.log("i:%d,_debtInAsset:%d", (i + 1), _debtInAsset);
            if (_debtInAsset == 0) {
                break;
            }
        }
        assertEq(_debtInAsset, 0);

        // redeem anything left from AAVE
        (uint256 _netSupply,,) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(false);
        bytes memory EMPTY_CALLDATA;
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).redeem(_netSupply, EMPTY_CALLDATA);
        vm.stopPrank();
        (_netSupply,,) = PendleAAVEStrategy(myStrategy).getNetSupplyAndDebt(false);
        assertEq(_netSupply, 0);

        // sell PT for underlying yield token
        DummyDEXRouter.TokenOutput memory _sellOutput = _getDummyTokenOutput(UNDERLYING_YIELD_ADDR3, 0);
        DummyDEXRouter.LimitOrderData memory emptyLimit;
        uint256 _ptResidueAmount = ERC20(address(PT_ADDR1)).balanceOf(myStrategy);
        bytes memory _sellCALLDATA = abi.encodeWithSelector(
            DummyDEXRouter.swapExactPtForToken.selector,
            myStrategy,
            address(MARKET_ADDR1),
            _ptResidueAmount,
            _sellOutput,
            emptyLimit
        );
        _prepareSwapForMockRouter(
            mockRouter, address(PT_ADDR1), address(UNDERLYING_YIELD_ADDR3), mockRouter._usdeWhale(), 150e16
        );
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).swapPTForAsset(UNDERLYING_YIELD_ADDR3, _ptResidueAmount, false, _sellCALLDATA);
        vm.stopPrank();
        assertEq(0, ERC20(address(PT_ADDR1)).balanceOf(myStrategy));

        // change to new PT
        _changeSettingToNewPT();

        // buy new PT with underlying yield token
        uint256 _yieldTokenBalance = ERC20(UNDERLYING_YIELD_ADDR3).balanceOf(myStrategy);
        DummyDEXRouter.TokenInput memory _buyInput = _getDummyTokenInput(UNDERLYING_YIELD_ADDR3, _yieldTokenBalance);
        bytes memory _buyCALLDATA = abi.encodeWithSelector(
            DummyDEXRouter.swapExactTokenForPt.selector,
            myStrategy,
            address(MARKET_ADDR3),
            0,
            _pendleSwapApproxParams,
            _buyInput,
            emptyLimit
        );
        _prepareSwapForMockRouter(
            mockRouter, address(UNDERLYING_YIELD_ADDR3), address(PT_ADDR3), PT3_Whale, USDC_TO_PT3_DUMMY_PRICE
        );
        {
            vm.expectRevert(Constants.ONLY_FOR_STRATEGIST_OR_OWNER.selector);
            vm.startPrank(_user);
            PendleAAVEStrategy(myStrategy).buyPTWithAsset(UNDERLYING_YIELD_ADDR3, _yieldTokenBalance, _buyCALLDATA);
            vm.stopPrank();
        }
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).buyPTWithAsset(UNDERLYING_YIELD_ADDR3, _yieldTokenBalance, _buyCALLDATA);
        vm.stopPrank();
        assertEq(0, ERC20(UNDERLYING_YIELD_ADDR3).balanceOf(myStrategy));
        uint256 _newPTBalance = ERC20(address(PT_ADDR3)).balanceOf(myStrategy);
        assertTrue(_yieldTokenBalance <= _newPTBalance);
        uint256 _ptValueInAsset = pendleHelper._getAmountInAsset(usdc, address(PT_ADDR3), _newPTBalance);
        assertEq(_ptValueInAsset + ERC20(usdc).balanceOf(myStrategy), PendleAAVEStrategy(myStrategy).totalAssets());
    }

    function test_Collect_Zero_Leverage_Pendle(uint256 _testVal) public {
        (myStrategy, strategist) = _createPendleStrategy(true);
        _fundFirstDepositGenerouslyWithERC20(mockRouter, address(stkVault), usdcPerETH);
        address _user = TestUtils._getSugarUser();

        TestUtils._makeVaultDepositWithMockRouter(
            mockRouter, address(stkVault), _user, usdcPerETH, _testVal, 10 ether, 100 ether
        );

        vm.expectRevert(Constants.INVALID_BPS_TO_SET.selector);
        vm.startPrank(aaveHelperOwner);
        aaveHelper.setLeverageRatio(Constants.TOTAL_BPS + 1);
        vm.stopPrank();

        vm.startPrank(aaveHelperOwner);
        aaveHelper.setLeverageRatio(0);
        vm.stopPrank();

        bytes memory EMPTY_CALLDATA;
        bytes memory _prepareCALLDATA =
            _generateSwapCalldataForBuy(myStrategy, address(MARKET_ADDR1), 0, magicUSDCAmount);
        _prepareSwapForMockRouter(mockRouter, usdc, address(PT_ADDR1), PT1_Whale, USDC_TO_PT1_DUMMY_PRICE);
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).allocate(magicUSDCAmount, abi.encode(_prepareCALLDATA, 0, EMPTY_CALLDATA));
        vm.stopPrank();

        _prepareSwapForMockRouter(
            mockRouter,
            address(PT_ADDR1),
            usdc,
            usdcWhale,
            (Constants.ONE_ETHER * Constants.ONE_ETHER / USDC_TO_PT1_DUMMY_PRICE)
        );

        uint256[] memory _previewCollect = aaveHelper.previewCollect(magicUSDCAmount);
        assertEq(3, _previewCollect.length);
        assertEq(2, _previewCollect[0]);

        bytes memory _collectCALLDATA =
            _generateSwapCalldataForSell(myStrategy, address(MARKET_ADDR1), 0, _previewCollect[1]);
        uint256 _assetBalance = ERC20(usdc).balanceOf(address(stkVault));
        vm.startPrank(strategist);
        PendleAAVEStrategy(myStrategy).collect(magicUSDCAmount, _collectCALLDATA);
        vm.stopPrank();
        assertTrue(
            _assertApproximateEq(
                magicUSDCAmount, (ERC20(usdc).balanceOf(address(stkVault)) - _assetBalance), 20 * MIN_SHARE
            )
        );
    }

    function test_AAVEHelper_basics() public {
        (myStrategy, strategist) = _createPendleStrategy(true);

        vm.expectRevert(Constants.INVALID_HELPER_CALLER.selector);
        aaveHelper.supplyToAAVE(magicUSDCAmount);
        vm.expectRevert(Constants.INVALID_HELPER_CALLER.selector);
        aaveHelper.borrowFromAAVE(magicUSDCAmount);
        vm.expectRevert(Constants.INVALID_HELPER_CALLER.selector);
        aaveHelper.repayDebtToAAVE(magicUSDCAmount);

        vm.startPrank(usdcWhale);
        ERC20(usdc).transfer(myStrategy, magicUSDCAmount);
        vm.stopPrank();

        uint256[] memory _previewAssets = aaveHelper.previewCollect(magicUSDCAmount);
        assertEq(2, _previewAssets.length);
        assertEq(magicUSDCAmount, _previewAssets[1]);

        vm.startPrank(PT1_Whale);
        ERC20(address(PT_ADDR1)).transfer(myStrategy, magicPTAmount);
        vm.stopPrank();
        _previewAssets = aaveHelper.previewCollect(magicUSDCAmount + magicUSDCAmount / 2);
        assertEq(3, _previewAssets.length);
        assertEq(1, _previewAssets[0]);
        assertEq(magicPTAmount, _previewAssets[2]);
    }

    function _printAAVEPosition() internal view returns (uint256, uint256) {
        (uint256 _cBase, uint256 _dBase, uint256 _leftBase, uint256 _liqThresh, uint256 _ltv, uint256 _healthFactor) =
            aavePool.getUserAccountData(address(myStrategy));
        console.log("_ltv:%d,_liqThresh:%d,_healthFactor:%d", _ltv, _liqThresh, _healthFactor);
        console.log("_cBase:%d,_dBase:%d,_leftBase:%d", _cBase, _dBase, _leftBase);
        return (_ltv, _healthFactor);
    }

    function _getZapInCalldataFromSDK(address _pendlePT, uint256 _assetAmount) internal view returns (bytes memory) {
        bytes memory _callData;
        if (_pendlePT == address(PT_ADDR1) && _assetAmount == magicUSDCAmount) {
            // slippage 2% with aggragator enabled
            _callData =
                hex"c81f847a000000000000000000000000f10b150ae0c2d2c0df82ae181dbcf2ea715734010000000000000000000000004339ffe2b7592dc783ed13cce310531ab366deac000000000000000000000000000000000000000000000042368f8b2e7a51e494000000000000000000000000000000000000000000000021c83ec99f8cc6844c00000000000000000000000000000000000000000000004a5223bb9235b4bca7000000000000000000000000000000000000000000000043907d933f198d0898000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000009184e72a00000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000cc0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000499602d20000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000d4e9b0d466789d7f6201442eeccba6a75a552db000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a24e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000007400000000000000000000000000000000000000000000000000000000000000440000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff00000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000404c134a970000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000e0e0e08a6a4b9dc7bd67bcb7aade5cf48157d44400000000000000000000000000000000000000000000000000000000499602d2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000053e2d6238da3000000320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000404c134a970000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000e0e0e08a6a4b9dc7bd67bcb7aade5cf48157d44400000000000000000000000000000000000000000000000000000000498d58220000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000346dc5d638865000000c800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000003b9cfbb2e541a0000000000000038da01f9e7aad46a30000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f94600000000000000000000000000000000000000000000000000000000499602d2000000000000000000000000000000000000000000000037b6ed74e82769c4390000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000499602d200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002887b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22313233332e393037373139373536313435222c22416d6f756e744f7574555344223a22313233352e31393138393435363636303537222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2231303438373236373739383736333738373030333336222c2254696d657374616d70223a313735303132363531362c22526f7574654944223a2231653464613462322d333337322d346637632d613337612d3834396339326534313838373a66346561393438312d363136662d343862652d396232362d303237316434626331663763222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22434743534f56476465486759444f4d633157325075483845735337465a487544686651664c333243674563376852466e445867645a494246577736684c374245627068676b506f3944592f454b674e72306f4a586d314d31497874496969526833536a4d493955333834576b39494748747a43474f4b4d484575705671624c5347454a584c6241782b49794c3644484555484f766b73782b3372584f7372706b5433664a7157654f2b2f77504c38684e3554716a2b697473457474414f5275695a33323069674e4b6c5841553946784451746a4844442b7a377a39506f5636546851574977594e647364474567427650746c6a78562f4d38327a4c6f727568416d32426f5754714345396a5a4263637a4c6972586333664b4d43754c786b6a6f47314b374d42573469746c3439686a46695442794a47724468485679637334594c503461706678756150436c4b583572454271785a673d3d227d7d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        } else if (_pendlePT == address(PT_ADDR1) && _assetAmount == magicUSDCAmountLeveraged) {
            // slippage 2% with aggragator enabled
            _callData =
                hex"c81f847a000000000000000000000000f10b150ae0c2d2c0df82ae181dbcf2ea715734010000000000000000000000004339ffe2b7592dc783ed13cce310531ab366deac0000000000000000000000000000000000000000000001e2d551a9369e4c7ea000000000000000000000000000000000000000000000000276935c06f1df0caa00000000000000000000000000000000000000000000021de87074e61a11339e000000000000000000000000000000000000000000000004ed26b80de3be1955000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000009184e72a00000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000e80000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000218711a000000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000d4e9b0d466789d7f6201442eeccba6a75a552db000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000be4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000006c000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff00000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004059a2f8610000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000a188eec8f81263234da3622a406892f3d630f98c0000000000000000000000000000000000000000000000000000000218711a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dc035d45d973e3ec169d2276ddab16f1e407384f000000000000000000000000a188eec8f81263234da3622a406892f3d630f98c0000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000044959912760000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000218711a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004073f998bb00000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000001e7e4171bf4d3a000000000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000040d90ce4910000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001000000000000000000000000003cef1afc0e8324b57293a6e7ce663781bbefbb79000000000000000000000000a3931d71877c0e7a3148cb7eb4463524fec27fbd0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ce31212fd27181af330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000001b2ab88b724c67000000000000019e889e6dc8ce5c8d01000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000000000000218711a000000000000000000000000000000000000000000000001963e34dc3a8ccb56fb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000218711a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002857b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22383939342e30313831313435323831222c22416d6f756e744f7574555344223a22393030302e343435353031393435323635222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2237363436373936343733303630343535393130363537222c2254696d657374616d70223a313735303132363437382c22526f7574654944223a2237663237633934322d383566652d346431322d616364662d6539313939373961663866643a33656364663033342d353736632d343861342d383937382d623833366635633734396131222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2248712f7a365132532f662f6b53375657466673536339423063594d576747764951685145436646744c4a6432394e564568334c4d37357048452f78635637396f334e31376d7361674f4e716c4365487773394e376d462b2b7054757134304f6757316e6d4f6a39774d634d4552636f504a37424b324c3651436b5153586279686d5332354841506e4a752b2f73505665797132374b637a74632f41543378526e4a4a4c5a4e446b62536253516347457a30493949552f414a6b787662624a546d39585748346962416e764f6233444161544a75414f7546416a6175665a42756d785866725352746e7848344b6864566d56524470504c31687973576544565141676c51514334384e5652646444756955626330537647584f6a7837414f7674433263394374567043533432554f5971767043484d735739734c2b50786a792b437064546d544c3755454a74574e354a43534945314b513d3d227d7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c9b3e2c3ec88b1b4c0cd853f4321000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000003bacb1cc2a30480f208bace3dc95f01d3f567f1030e7fe9ff8e8f06f463857b30fee4658a9eed3d4f0000000000000000000000000000000000000000000000000000000068521e9b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000b7e51d15161c49c823f3951d579ded61cd27272b000000000000000000000000d0076b85c236d38628f692bc5aa9e8b77edfed15000000000000000000000000d0076b85c236d38628f692bc5aa9e8b77edfed150000000000000000000000000000000000000000000008ba7611ab6bb6866880000000000000000000000000000000000000000000000000010b3a3dd3ed5fc50000000000000000000000000000000000000000000000000c7d713b49da00000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000416c12b2f3d8a90169b168bc0cb0b801c2124d71fd097045243149450dc405b45c160dcb76935f3600d2fc431c1654e0c146546172e166e1cdb0bd5176f4543d571c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        }
        return _callData;
    }

    function _getStormOutCalldataFromSDK(address _pendlePT, uint256 _ptAmount) internal view returns (bytes memory) {
        bytes memory _callData;
        if (_pendlePT == address(PT_ADDR1) && _ptAmount == magicPTAmountRedeemed) {
            // slippage 2% with aggragator enabled
            _callData =
                hex"594a88cc000000000000000000000000f10b150ae0c2d2c0df82ae181dbcf2ea715734010000000000000000000000004339ffe2b7592dc783ed13cce310531ab366deac00000000000000000000000000000000000000000000000ad78ebc5ac620000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000f40000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000b93c2090000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000d4e9b0d466789d7f6201442eeccba6a75a552db000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000d44e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000008400000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000780000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff0000000000000000000000000000000000000000000000000000000000000720000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000404c134a970000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000e0e0e08a6a4b9dc7bd67bcb7aade5cf48157d4440000000000000000000000000000000000000000000000094d70f79f122de2ef0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000346dc5d638865000000c80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000408bf36a3b0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90000000000000000000000000000000000000000000000000000000000c088c4d000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000001f9840a85d5af5bf1d1762f925bdaddc4201f9840000000000000000000000000000000000000000000000000000000000000bb8000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000005a63f625a75045f639ef0000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040ca6182da00000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000007a819fa46734a49d0112796f9377e024c350fb2600000000000000000000000000000000000000006850cf8d788dbd6dd486f6f2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000001f9840a85d5af5bf1d1762f925bdaddc4201f984000000000000000000000000bee3211ab312a8d065c4fef0247448e17a8da0000000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000c0cc22f0000000000000000000000000000000000000000000000017151c98518d3bf5f00000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000017151c98518d3bf5f0000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000041955d6185361b02c425c0cbc98f3a86376cb5383ae4cb753a7a1eb1a36ba6db4816b0b1f9ee76c24f41436cc79866e0573bbda143bfed676accad13e650ed1b5a1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000ca0000000000000000000000000c0cc22f0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000094d70f79f122de2ef000000000000000000000000000000000000000000000000000000000bcf087a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000094d70f79f122de2ef000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027c7b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a223230322e3134373333393232323939323937222c22416d6f756e744f7574555344223a223230322e3231353435373537373533373235222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22323032313630373133222c2254696d657374616d70223a313735303132363433332c22526f7574654944223a2262373031353831342d666236322d346237322d613036362d6533373165366431353466653a33393131663933342d383461622d343861332d396232662d353533643332643062626331222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2245445a7976554b734a6a732f6376586c59466435427343336a444c6e4b4b7a5765646a4d464d62666242466833435948703977614b7a4b6b4b474765785a6445696b4664316f516c31527749464f75763938416b4842584239624f5142576139387a677a667968445850634d2f4734565236375239335933565343463748687a4b56373167534c6e487a65656131614a5835344138645053326938524d6b6a7a524b6b654c5770704d7544706c5176715641304638574d714c5a384864494a32674867337a43426c77563753376c746b494a4465314b546b62415672415170507876647647453974314165494c4d3448576364314645506b4e514a4b38304b7a34324e486f6b3874327252614747335932366b744e6a35696e3176333355685077705a64616c4a6d774a313844432b6e6c594147767a737246535844382f666e465968493449356e464a61493361492b3869515852513d3d227d7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        } else if (_pendlePT == address(PT_ADDR1) && _ptAmount == magicPTAmountCollected) {
            // slippage 2% with aggragator enabled
            _callData =
                hex"594a88cc000000000000000000000000f10b150ae0c2d2c0df82ae181dbcf2ea715734010000000000000000000000004339ffe2b7592dc783ed13cce310531ab366deac0000000000000000000000000000000000000000000000c328093e61ee40000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000d03166db0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000d4e9b0d466789d7f6201442eeccba6a75a552db000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000a04e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000007400000000000000000000000000000000000000000000000000000000000000440000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff00000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000007eb59373d63627be64b42406b108b602174b4ccc0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000a771e8d5e5d9126c4e00000000000000000000000000000000000000000000000000000001000276a4000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000404c134a970000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000e0e0e08a6a4b9dc7bd67bcb7aade5cf48157d44400000000000000000000000000000000000000000000000000000000d897bb9c000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000053e2d6238da30000003200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000e33000000000000000000000000d8b0ce520000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000a771e8d5e5d9126c4e00000000000000000000000000000000000000000000000000000000d45b598d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000a771e8d5e5d9126c4e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002797b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22333633392e3639333936373330353534222c22416d6f756e744f7574555344223a22333634302e3535383230383235393438222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2233363335343635383130222c2254696d657374616d70223a313735303132363339372c22526f7574654944223a2234383330356437632d336435362d346133392d616631392d3538623433376166383838623a39613131613765382d343634342d346336652d383836662d396430323433356432336639222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2258367848446c535a4d6d695576716a58505a77504b696c7062787942553476546c7462365a726d6d65724476312b53494442386e4d4641694574654c6b4c776973746a68563763787643415257574e474f4468652b39714a7365714b6a67384c674a4e4f4f764c4356454a4971596a6c61555a726c73707662414f56553551305951637365785a757732674b572f3559577358324253715164675252554b326b77457931313131667772736866626445516239534e64747747426c6444303571576736764e557849725343464b5a545a59337552466d7867663374456170394d59316f6c4f4c6265745a376e432f716b2f77367564592b6e36703833494e773230465153385a4561726c7053337469745172513763532b61735a32515155456a573357595867786958636a36746f574858704175446551367475445650776c422b4b4267633775365455366f6a356d50596e4f4945413d3d227d7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        } else if (_pendlePT == address(PT_ADDR1) && _ptAmount == magicPTAmountCollectAll) {
            // slippage 2% with aggragator enabled
            _callData =
                hex"594a88cc000000000000000000000000f10b150ae0c2d2c0df82ae181dbcf2ea715734010000000000000000000000004339ffe2b7592dc783ed13cce310531ab366deac00000000000000000000000000000000000000000000015af1d78b58c400000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000001320000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000172221a3c0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000d4e9b0d466789d7f6201442eeccba6a75a552db000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000001124e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000c200000000000000000000000000000000000000000000000000000000000000e600000000000000000000000000000000000000000000000000000000000000b60000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff0000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000007400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000004e000000000000000000000000000000000000000000000000000000000000000404c134a970000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000e0e0e08a6a4b9dc7bd67bcb7aade5cf48157d444000000000000000000000000000000000000000000000020bea90cb04efc2e6f0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000346dc5d638865000000c80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000408934ba230000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000111111125421ca6dc452d289314280a0f8842a65000000000000000000000000000000000000000000000000000000002a5b2aed000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000044c60edbbf80e265874d124200000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000514910771af9ca656af840dff83e8264ecf986ca000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000002d750b769b1778634000000000000000000000000000000000000000000000000000000002a5b2aed0000000000000000000000000000b43032006850cefd8608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000040c8aab20833ee811dd39ee485f1fa155fcab31efbeb9f9ef1f6cb25dca3466fd77c9f386a62528cc60dfa638ab8cc366b08482ffff1bdf829e3b4e05fc0346d4200000000000000000000000000000000000000000000000000000000000000146e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000000000000000000000000000408bf36a3b0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90000000000000000000000000000000000000000000000002d76ade57b186c64a000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3000000000000000000000000514910771af9ca656af840dff83e8264ecf986ca000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000bb8000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000100ad139d0000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000007eb59373d63627be64b42406b108b602174b4ccc0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000108ef57c3c10ab28e9900000000000000000000000000000000000000000000000000000001000276a4000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000404c134a970000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000e0e0e08a6a4b9dc7bd67bcb7aade5cf48157d4440000000000000000000000000000000000000000000000000000000156b2758a000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000053e2d6238da3000000320000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000193f000000000000000000000001813d9deb0000000000000000000000009d39a5de30e57443bff2a8307a4256c8797a3497000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000129ae00d07159aebd080000000000000000000000000000000000000000000000000000000179892f3d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000129ae00d07159aebd08000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027b7b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22363436352e313237303133343933383531222c22416d6f756e744f7574555344223a22363436312e303337373136303236383338222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2236343633323636323833222c2254696d657374616d70223a313735303132363237332c22526f7574654944223a2233326664303136392d383463312d343635342d613064622d6332323634303362653139313a37646639343839362d336239342d343330652d396535302d373739356230656338663138222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22492b2b7472485a7457395a39747a49464c6243414f757a2f775a46636a2b634f4578653242366a3078696c54414c666d5a6b5541595a37652b65357979643134736b5865724c535231477356684b4e5851644b782f5251474549534a3077374a6752767a7943375672447a427434786f3343774830514c2b59724e336f75357943656b6c325173646d4e5957696578374e724d656177745159384243357a71514d6453777864784d73725473443758713443746e37387634514161572b774251556c685667304462445530766f7568713467773449484c786a37356f7a654c376c52534e673362516c5076685932714147784f764769497475306533525657683068624644636a644f41505a78616f344b3068554247436d55704f6c57647844437334457a364c4d536966366f7066354c4c62656c65686737386e4f486b325a6b774434586c536b38364e444b4765324533774c75773d3d227d7d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        }
        return _callData;
    }

    function _createPendleStrategy(bool _useMockRouter) internal returns (address, address) {
        bytes memory _constructorArgs = abi.encode(usdc, address(stkVault));
        address _deployedStrategy = deployWithCreationCodeAndConstructorArgs(
            PENDLE_AAVE_STRATEGY_NAME, type(PendleAAVEStrategy).creationCode, _constructorArgs
        );

        assertEq(_deployedStrategy, PENDLE_AAVE_STRATEGY_ADDRESS);

        aaveHelper = new AAVEHelper(_deployedStrategy, ERC20(address(PT_ADDR1)), ERC20(usdc), ERC20(PT_ATOKEN_ADDR1), 8);
        aaveHelperOwner = aaveHelper.owner();

        vm.startPrank(stkVOwner);
        stkVault.addStrategy(_deployedStrategy, 100);
        vm.stopPrank();

        strategyOwner = PendleAAVEStrategy(_deployedStrategy).owner();

        address _routerAddr = (_useMockRouter ? address(mockRouter) : pendleRouterV4);
        pendleHelper = new PendleHelper(_deployedStrategy, _routerAddr, address(swapper));

        vm.startPrank(strategyOwner);
        PendleAAVEStrategy(_deployedStrategy).setSwapper(address(swapper));
        PendleAAVEStrategy(_deployedStrategy).setAAVEHelper(address(aaveHelper));
        PendleAAVEStrategy(_deployedStrategy).setPendleHelper(address(pendleHelper));
        PendleAAVEStrategy(_deployedStrategy).setPendleMarket(address(MARKET_ADDR1));
        vm.stopPrank();

        return (_deployedStrategy, PendleAAVEStrategy(_deployedStrategy).strategist());
    }

    function _changeSettingToNewPT() internal {
        vm.expectRevert(Constants.WRONG_EMODE.selector);
        vm.startPrank(aaveHelperOwner);
        aaveHelper.setTokens(ERC20(address(PT_ADDR3)), ERC20(usdc), ERC20(PT_ATOKEN_ADDR3), 0);
        vm.stopPrank();

        vm.startPrank(aaveHelperOwner);
        aaveHelper.setTokens(ERC20(address(PT_ADDR3)), ERC20(usdc), ERC20(PT_ATOKEN_ADDR3), 10);
        vm.stopPrank();

        address _strategyOwner = PendleAAVEStrategy(myStrategy).owner();
        vm.expectRevert(Constants.DIFFERENT_TOKEN_IN_AAVE_HELPER.selector);
        vm.startPrank(_strategyOwner);
        PendleAAVEStrategy(myStrategy).setPendleMarket(address(MARKET_ADDR2));
        vm.stopPrank();

        vm.startPrank(_strategyOwner);
        PendleAAVEStrategy(myStrategy).setPendleMarket(address(MARKET_ADDR3));
        vm.stopPrank();

        uint256 _ltv = aaveHelper.getMaxLTV();
        assertTrue(_ltv >= 9000 && _ltv <= 9060);
    }
}
